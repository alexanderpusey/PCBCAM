<!doctype html/>
<html>
	<head>
		<title>PCBCAM</title>
	</head>
	<body style="background-color: rgb(0, 67, 129)">
		<canvas id="canvas" width=800 height=800 style="background-color: black;"></canvas>
		<textarea readonly id="text-area" style="width: 800px; height: 800px; background-color: rgb(0, 67, 129); color: white; resize: none; font-family: monospace; font-size: 15px; border: none"></textarea>
	</body>
	<script>
		const canvas = document.getElementById("canvas")
		const ctx = canvas.getContext("2d")
		const textArea = document.getElementById("text-area")
		
		json = {
			"config" : {
				"scale" : 7,
				"windowPos" : [0,0],
				"boardX" : 70.4,
				"boardY" : 101,
				"showNames" : false,
				"showPackage" : true
			},
			"devices" : [
				{
					"name" : "555",
					"placement" : [10,5],
					"pattern" : [2, 4, 7.6, 2.2],
					"drill" : true,
					"pad" : [1.75, 1.75],
				},
				{
					"name" : "5V",
					"placement" : [25,25],
					"pattern": [1,1,0,0],
					"drill": false,
					"pad": [5,5],
				},
				{
					"name" : "GND",
					"placement" : [20,20],
					"pattern": [1,1,0,0],
					"drill": false,
					"pad": [5,5],
				},
				{
					"name" : "1KOHM",
					"placement" : [30,10],
					"pattern": [2,1,4,0],
					"drill": true,
					"pad": [1.75,1.75],
				},
				{
					"name" : "100KOHM",
					"placement" : [20,25],
					"pattern": [2,1,4,0],
					"drill": true,
					"pad": [1.75,1.75],
				},
				{
					"name" : "LED",
					"placement" : [35,40],
					"pattern": [2,1,4,0],
					"drill": true,
					"pad": [1.75,1.75],
				},
				{
					"name" : "1MFD",
					"placement" : [31,14],
					"pattern": [2,1,4,0],
					"drill": true,
					"pad": [1.75,1.75],
				},
				{
					"name" : "220OHM",
					"placement" : [45,21],
					"pattern": [2,1,4,0],
					"drill": true,
					"pad": [1.75,1.75],
				},
			],
			"traces" : [],
		}
		
		let devices = []

		class Device {
			constructor(name, placement, pattern, drill, pad) {
				this.name = name
				this.xpos = placement[0]
				this.ypos = placement[1]
				this.xpat = pattern[0]
				this.ypat = pattern[1]
				this.xspace = pattern[2]
				this.yspace = pattern[3]
				this.drill = drill
				this.xpad = pad[0]
				this.ypad = pad[1]
			}

			draw(scale, windowPos, showNames) {
				for (let i = 0; i < this.ypat; i++) {
					for (let j = 0; j < this.xpat; j++) {
						let x = ((this.xpos + (j * this.xspace)) * scale) + json.config.windowPos[0]
						let y = ((this.ypos + (i * this.yspace)) * scale) + json.config.windowPos[1]
						// connections
						ctx.fillStyle = "white"
						ctx.beginPath()
   						ctx.arc(x, y, 1, 0, 2 * Math.PI)
						ctx.fill()
						// holes
						if (this.drill) {
							ctx.strokeStyle = "white"
							ctx.beginPath()
							// 0.5 drill RADIUS
							ctx.arc(x, y, 0.5 * scale, 0, 2 * Math.PI)
							ctx.stroke()
						}
						// pads
						ctx.beginPath()
						ctx.rect(x - (this.xpad * scale / 2), y - (this.xpad * scale / 2), this.xpad * scale, this.ypad * scale)
						ctx.stroke()
					}
				}
				let x = this.xpos*scale+json.config.windowPos[0]
				let y = this.ypos*scale+json.config.windowPos[1]
				// name
				if (showNames) {
					ctx.beginPath()
					ctx.font = `${2 * scale}px monospace`
					ctx.fillText(this.name, x, y)
				}
				// package
				if (json.config.showPackage) {
					if (this.packageShape == "rect") {
						ctx.beginPath()
						ctx.rect(this.originX+this.packageOffsetX, this.originY+this.packageOffsetY, this.packageX*scale, this.packageY*scale)
						ctx.stroke()
					}
					else if (this.packageShape == "circle") {
						ctx.beginPath()
						ctx.arc(this.originX+this.packageOffsetX, this.originY+this.packageOffsetY, this.packageX*scale, 0, 2*Math.PI)
						ctx.stroke()
					}
				}
			}
		}

		for (let device of json.devices) {
			devices.push(new Device(device.name, device.placement, device.pattern, device.drill, device.pad))
		}

		function zoom(multiplier) {
			json.config.scale = json.config.scale * multiplier
			render()
		}

		function render() {
			// update text area to recent json
			textArea.textContent = JSON.stringify(json)
			// clears canvas
			ctx.clearRect(0, 0, canvas.width, canvas.height)

			// draws board
			ctx.strokeStyle = "red"
			ctx.beginPath()
			ctx.rect(json.config.windowPos[0], json.config.windowPos[1], json.config.boardX*json.config.scale, json.config.boardY*json.config.scale)
			ctx.stroke()

			// draws devices
			for (let device of devices) {
				device.draw(json.config.scale, json.config.windowPos,json.config.showNames)
			}
		}

		render()
		
		// keyboard navigation
		let movementFactor = 1
		document.addEventListener("keydown", (e) => {
			switch (e.key) {
				case "ArrowUp":
					e.preventDefault()
					json.config.windowPos[1]+=movementFactor*json.config.scale
					render()
					break
				case "ArrowDown":
					e.preventDefault()
					json.config.windowPos[1]-=movementFactor*json.config.scale
					render()
					break
				case "ArrowLeft":
					e.preventDefault()
					json.config.windowPos[0]+=movementFactor*json.config.scale
					render()
					break
				case "ArrowRight":
					e.preventDefault()
					json.config.windowPos[0]-=movementFactor*json.config.scale
					render()
					break
				case "=":
					e.preventDefault()
					zoom(2)
					break
				case "-": 
					e.preventDefault()
					zoom(0.5)
					break 
				case ".":
					e.preventDefault()
					json.config.showNames = !json.config.showNames
					render()
					break
			}
		})
		
	</script>
</html>
