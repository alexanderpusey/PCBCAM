<!doctype html/>
<html>
	<head>
		<title>PCBCAM</title>
		<style>
			* {
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body style="background-color: gray; overflow: hidden">
		<canvas id="canvas" width=700 height=700 style="background-color: black;"></canvas>
	</body>
	<script>
		const canvas = document.getElementById("canvas")
		const ctx = canvas.getContext("2d")

		json = 
		{"config":{"scale":16,"windowPos":[16,48],"boardX":70.4,"boardY":101,"showNames":false,"showPackages":true,"showCoordinates":false,"showAxes":true,"showNumbers":true},"devices":[{"name":"555 Timer","origin":[20,20],"package":{"style":"rect","dim":[6.2,9.3],"offset":[0,0]},"points":[{"pos":[-3.75,-3.6],"drill":true,"pad":[1.75,1.75]},{"pos":[-3.75,-1.2],"drill":true,"pad":[1.75,1.75]},{"pos":[-3.75,1.2],"drill":true,"pad":[1.75,1.75]},{"pos":[-3.75,3.6],"drill":true,"pad":[1.75,1.75]},{"pos":[3.75,-3.6],"drill":true,"pad":[1.75,1.75]},{"pos":[3.75,-1.2],"drill":true,"pad":[1.75,1.75]},{"pos":[3.75,1.2],"drill":true,"pad":[1.75,1.75]},{"pos":[3.75,3.6],"drill":true,"pad":[1.75,1.75]}]},{"name":"5V","origin":[25,10],"points":[{"pos":[0,0],"drill":false,"pad":[7,7]}]},{"name":"GND","origin":[15,10],"points":[{"pos":[0,0],"drill":false,"pad":[7,7]}]},{"name":"1KOHM","origin":[35,16],"package":{"style":"rect","dim":[6.3,2.25],"offset":[0,0]},"points":[{"pos":[-5,0],"drill":true,"pad":[1.75,1.75]},{"pos":[5,0],"drill":true,"pad":[1.75,1.75]}]},{"name":"100KOHM","origin":[35,20],"package":{"style":"rect","dim":[6.3,2.25],"offset":[0,0]},"points":[{"pos":[5,0],"drill":true,"pad":[1.75,1.75]},{"pos":[-5,0],"drill":true,"pad":[1.75,1.75]}]},{"name":"220OHM","origin":[10,25],"package":{"style":"rect","dim":[2.25,6.3],"offset":[0,0]},"points":[{"pos":[0,5],"drill":true,"pad":[1.75,1.75]},{"pos":[0,-5],"drill":true,"pad":[1.75,1.75]}]},{"name":"1MFD","origin":[10,17],"package":{"style":"circle","dim":[5,5],"offset":[0,0]},"points":[{"pos":[1.25,0],"drill":true,"pad":[1.75,1.75]},{"pos":[-1.25,0],"drill":true,"pad":[1.75,1.75]}]},{"name":"LED","origin":[20,30],"package":{"style":"circle","dim":[5.4,5.4],"offset":[0,0]},"points":[{"pos":[1.5,0],"drill":true,"pad":[1.75,1.75]},{"pos":[-1.5,0],"drill":true,"pad":[1.75,1.75]}]}],"traces":[]}

		let devices = []
		let selectedDevices = []

		class Device {
			constructor(index, JSONDevice) {
				this.index = index
				this.name = JSONDevice.name
                this.origin = JSONDevice.origin
				this.pk = JSONDevice.package
                this.points = JSONDevice.points
			}

            rotate() {
				if (this.pk) {
					json.devices[this.index].package.dim.reverse()
					json.devices[this.index].package.offset.reverse()
				}
				for (let point of json.devices[this.index].points) {
					point.pos.reverse()
					point.pos[0] = -point.pos[0]
					point.pad.reverse()
				}
				render()
            }

			translate(x, y) {
				json.devices[this.index].origin[0] += x
				json.devices[this.index].origin[1] += y
				render()
			}

			move(x, y) {
				json.devices[this.index].origin = [x,y]
				render()
			}

			alignpoints(selfPointIndex, targetPoint) {
				
				let selfoffset = this.points[selfPointIndex].pos
				console.log(selfoffset)
				console.log(targetPoint)
				render()
			}

            convert(coordinates, scale, windowPos=[0,0]) {
                return [
                    (coordinates[0] * scale) + windowPos[0], 
                    (coordinates[1] * scale) + windowPos[1]
                ]
            }

			draw(scale, windowPos, showNames, showPackages, showCoordinates, showNumbers) {

                // origin calculations
                let deviceOrigin = this.convert(this.origin, scale, windowPos)
                let wcsOrigin = [windowPos[0], windowPos[1]]
                
				// name
				if (showNames) {
					ctx.fillStyle = "white"
					ctx.beginPath()
					ctx.font = `${1 * scale}px monospace`
					ctx.fillText(`[${this.index}]${this.name}`, deviceOrigin[0], deviceOrigin[1])
				}

				// package/origin
				if (showPackages) {

					//origin
					ctx.fillStyle = "red"
					ctx.beginPath()
					ctx.arc(
						deviceOrigin[0],
						deviceOrigin[1],
						0.05 * scale, 
						0, 
						2 * Math.PI
					)
					ctx.fill()

                    // origin coordinates
                    if (showCoordinates) {
                        ctx.fillStyle = "red"
						ctx.beginPath()
						ctx.font = `${0.5 * scale}px monospace`
						ctx.fillText(`[${this.origin[0]},${this.origin[1]}]`, deviceOrigin[0], deviceOrigin[1])
                    }

					// if package information exists
					if (this.pk) {
						// rect package
						if (this.pk.style == "rect") {
							ctx.strokeStyle = "red"
							ctx.beginPath()
							ctx.rect(
								deviceOrigin[0] - (this.pk.dim[0] * 0.5 * scale), 
								deviceOrigin[1] - (this.pk.dim[1] * 0.5 * scale), 
								this.pk.dim[0]*scale,
								this.pk.dim[1]*scale
							)
							ctx.stroke()
						}
						// circle package
						else if (this.pk.style == "circle") {
							ctx.strokeStyle = "red"
							ctx.beginPath()
							ctx.arc(
								deviceOrigin[0],
								deviceOrigin[1], 
								this.pk.dim[0]/2*scale, 
								0, 
								2*Math.PI
							)
							ctx.stroke()
						}
					}
				}

                // points 
                for (let i = 0; i < this.points.length; i ++) {

					let point = this.points[i]

                    let cPoint = this.convert(point.pos, scale)

					// connections
					if (showPackages) {
						ctx.fillStyle = "yellow"
						ctx.beginPath()
						ctx.arc(
						deviceOrigin[0] + cPoint[0], 
						deviceOrigin[1] + cPoint[1], 
						0.05 * scale, 
						0, 
						2 * Math.PI)
						ctx.fill()
					}

					if (showNumbers) {
						ctx.font = `${0.5 * scale}px monospace`
						ctx.fillText(i + 1, deviceOrigin[0] + cPoint[0], deviceOrigin[1] + cPoint[1])
					}

					// point coordinates
					if (showCoordinates) {
						ctx.fillStyle = "red"
						ctx.beginPath()
						ctx.font = `${0.5 * scale}px monospace`
						ctx.fillText(`[${this.origin[0] + point.pos[0]},${this.origin[1] + point.pos[1]}]`, deviceOrigin[0] + cPoint[0], deviceOrigin[1] + cPoint[1])
					}

					// holes
                    if (point.drill) {
                        ctx.strokeStyle = "white"
                        ctx.beginPath()
                        // 0.5 drill RADIUS
                        ctx.arc(
							deviceOrigin[0] + cPoint[0], 
							deviceOrigin[1] + cPoint[1], 
							0.5 * scale, 
							0, 
							2 * Math.PI)
                        ctx.stroke()
                    }

					//pads
					ctx.strokeStyle = "white"
					ctx.beginPath()
					ctx.rect(
						deviceOrigin[0] + cPoint[0] - (point.pad[0] * 0.5 * scale), 
						deviceOrigin[1] + cPoint[1] - (point.pad[1] * 0.5 * scale), 
						point.pad[0] * scale, 
						point.pad[1] * scale)
					ctx.stroke()
                }

			}
		}

		function render() {
			// clears canvas
			ctx.clearRect(0, 0, canvas.width, canvas.height)

            // creates devices from json
			devices = []
		    for (const [index, device] of json.devices.entries()) {
			    devices.push(new Device(index, device))
		    }

			// board boundary
			ctx.strokeStyle = "white"
			ctx.beginPath()
			ctx.rect(json.config.windowPos[0], json.config.windowPos[1], json.config.boardX*json.config.scale, json.config.boardY*json.config.scale)
			ctx.stroke()

			// axes
			if (json.config.showAxes) {
				ctx.fillStyle="white"
				ctx.font = `${0.5 * json.config.scale}px monospace`
				for (i = 0; i <= Math.floor(json.config.boardX); i += 10) {
					ctx.fillText(i, json.config.windowPos[0] + i * json.config.scale, json.config.windowPos[1] + 1 * json.config.scale)
				}
				for (i = 0; i <= Math.floor(json.config.boardY); i += 10) {
					ctx.fillText(i, json.config.windowPos[0] + 0.5 * json.config.scale, json.config.windowPos[1] + i * json.config.scale)
				}
			}

			// draw devices
			for (let device of devices) {
				device.draw(
					json.config.scale, 
					json.config.windowPos, 
					json.config.showNames, 
					json.config.showPackages,
					json.config.showCoordinates,
					json.config.showNumbers
				)
			}
		}

		// navigation
		function zoomin() {
			json.config.scale = json.config.scale * 2
			render()
		}

		function zoomout() {
			json.config.scale = json.config.scale * 0.5
			render()
		}

        function resetzoom() {
            json.config.scale = 1
            json.config.windowPos = [0,0]
            render()
        }

		function pan(direction) {
			switch (direction) {
				case "down":
					json.config.windowPos[1]-=json.config.scale
					break
				case "left":
					json.config.windowPos[0]+=json.config.scale
					break
				case "right":
					json.config.windowPos[0]-=json.config.scale
					break
				case "up":
					json.config.windowPos[1]+=json.config.scale
					break
			}
			render()
		}


		// layer visibility
		function shownames() {
			json.config.showNames = !json.config.showNames
			render()
		}

		function showpackages() {
			json.config.showPackages = !json.config.showPackages
			render()
		}

		function showcoordinates() {
			json.config.showCoordinates = !json.config.showCoordinates
			render()
		}

		function showaxes() {
			json.config.showAxes = !json.config.showAxes
			render()
		}

		function shownumbers() {
			json.config.showNumbers = !json.config.showNumbers
			render()
		}


		// devices
		function move(selected = selectedDevices, x = 0, y = 0) {
			selected.forEach((index) => devices[index].move(x, y))
		}

		function translate(selected = selectedDevices, x = 0, y = 0) {
			selected.forEach((index)=> devices[index].translate(x,y))
		}

		function rotate(selected = selectedDevices) {
			selected.forEach((index) => devices[index].rotate())
		}


		// "save"
		function save() { console.log(JSON.stringify(json)) }


		// keybinds
		document.addEventListener("keydown", (e) => {
			switch(e.key) {
				case "ArrowDown":
					pan("down")
					break
				case "ArrowLeft":
					pan("left")
					break
				case "ArrowRight":
					pan("right")
					break
				case "ArrowUp":
					pan("up")
					break
				case "-":
					zoomout()
					break
				case "=":
					zoomin()
					break
			}
		})

		render()
		
	</script>
</html>